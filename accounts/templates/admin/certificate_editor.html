<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enhanced Certificate Template Editor</title>
  <style>
    :root {
      --primary-color: #3794D0;
      --primary-dark: #026aaf;
      --background: #f1f5f9;
      --card-bg: #fff;
      --danger: #ff7675;
      --danger: #ff7675;
      --light: #f8f9fa;
      --dark: #2d3436;
      --gray: #dfe6e9;
      --border-color: #e2e8f0;
      --text-dark: #1e293b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--background);
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    .editor-container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 320px;
      background: var(--card-bg);
      border-right: 1px solid var(--border-color);
      padding: 1.5rem;
      overflow-y: auto;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
    }

    .canvas-area {
      flex: 1;
      background: #e5e7eb;
      position: relative;
      overflow: auto;
      padding: 20px;
    }

    .canvas-container {
      position: relative;
      display: inline-block;
      min-width: 100%;
      min-height: 100%;
    }

    .canvas {
      position: relative;
      width: 794px;
      height: 1123px;
      background: white;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      border-radius: 8px;
      overflow: hidden;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      margin: 0 auto;
    }

    .zoom-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      gap: 8px;
      align-items: center;
      z-index: 1000;
    }

    .zoom-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border-color);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .zoom-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    .zoom-level {
      font-size: 12px;
      color: var(--text-dark);
      min-width: 40px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
    }

    input, select {
      width: 100%;
      padding: 0.75rem;
      font-size: 0.95rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .canvas-settings {
      margin-bottom: 1.5rem;
      background: #f8fafc;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .canvas-size-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .canvas-size-controls input {
      padding: 0.5rem;
      font-size: 0.8rem;
    }

    .preset-sizes {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .preset-btn {
      padding: 0.25rem 0.5rem;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.7rem;
    }

    .preset-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    .placeholder-section {
      margin-bottom: 1.5rem;
      background: #f8fafc;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .placeholder-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .placeholder-btn {
      padding: 0.5rem;
      background: white;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 0.7rem;
      cursor: pointer;
      color: #475569;
      transition: all 0.2s ease;
      text-align: center;
      word-break: break-all;
      line-height: 1.2;
    }

    .placeholder-btn:hover {
      background: #f1f5f9;
      border-color: var(--primary-color);
      transform: translateY(-1px);
    }

    .text-element {
      position: absolute;
      cursor: move;
      border: 2px dashed transparent;
      padding: 8px;
      min-width: 100px;
      min-height: 30px;
      background: rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
      outline: none;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .text-element:hover {
      border-color: var(--primary-color);
      background: rgba(55, 148, 208, 0.05);
    }

    .text-element.selected {
      border-color: var(--primary-color);
      border-style: solid;
      background: rgba(55, 148, 208, 0.1);
    }

    .text-element.editing {
      cursor: text;
      background: rgba(255, 255, 255, 0.9);
    }

    .resize-handle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: var(--primary-color);
      border: 2px solid white;
      border-radius: 50%;
    }

    .resize-handle.nw { top: -4px; left: -4px; cursor: nw-resize; }
    .resize-handle.ne { top: -4px; right: -4px; cursor: ne-resize; }
    .resize-handle.sw { bottom: -4px; left: -4px; cursor: sw-resize; }
    .resize-handle.se { bottom: -4px; right: -4px; cursor: se-resize; }

    /* Sidebar Toolbar Styles */
    .text-formatting {
      margin-bottom: 1.5rem;
      background: #f8fafc;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      display: none;
    }

    .text-formatting.show {
      display: block;
    }

    .selected-element-info {
      background: #eff6ff;
      padding: 0.5rem;
      border-radius: 4px;
      margin-bottom: 1rem;
      font-size: 0.8rem;
      color: var(--primary-dark);
      border-left: 3px solid var(--primary-color);
    }

    .formatting-group {
      margin-bottom: 1rem;
    }

    .formatting-group-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      display: block;
    }

    .button-group {
      display: flex;
      gap: 0.25rem;
      margin-bottom: 0.5rem;
    }

    .format-btn {
      flex: 1;
      padding: 0.5rem;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .format-btn:hover {
      background: #f8fafc;
    }

    .format-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .input-group label {
      font-size: 0.8rem;
      margin: 0;
      min-width: 60px;
    }

    .input-group input,
    .input-group select {
      padding: 0.5rem;
      font-size: 0.8rem;
    }

    .color-opacity-group {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .color-input {
      width: 40px;
      height: 35px;
      padding: 2px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
    }

    .opacity-slider {
      flex: 1;
    }

    .add-text-btn {
      background: var(--primary-color);
      color: white;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      width: 100%;
      margin-bottom: 1rem;
    }

    .add-text-btn:hover {
      background: var(--primary-dark);
    }

    .layer-controls {
      margin-bottom: 1rem;
      background: #f8fafc;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .layer-btn {
      padding: 0.5rem;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      margin: 0 0.25rem;
    }

    .layer-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    .save-btn {
      background: #059669;
      color: white;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      width: 100%;
      margin-top: 1rem;
    }

    .save-btn:hover {
      background: #047857;
    }
    .cancel-btn {
            background: white;
            color: var(--danger);
            border: 2px solid var(--danger);
            box-shadow: 0 4px 15px rgba(255, 118, 117, 0.1);
        }
        
        .cancel-btn:hover {
            background: var(--danger);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 118, 117, 0.3);
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.9rem 2rem;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
    .preview-section {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-color);
    }

    .preview-link {
      color: var(--primary-color);
      font-size: 0.9rem;
      font-weight: 500;
      text-decoration: none;
      margin-top: 0.5rem;
      display: inline-block;
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-dark);
      margin-bottom: 0.75rem;
    }

    #backgroundUpload {
      margin-bottom: 0.5rem;
    }

    .background-preview {
      width: 100%;
      height: 120px;
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      color: #64748b;
      font-size: 0.8rem;
      text-align: center;
      margin-top: 0.5rem;
    }

    .delete-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .text-element.selected .delete-btn {
      display: flex;
    }

    .background-fit-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
     

    .fit-btn {
      padding: 0.25rem 0.5rem;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.7rem;
    }

    .fit-btn:hover {
      background: var(--primary-color);
      color: white;
    }

    .fit-btn.active {
      background: var(--primary-color);
      color: white;
    }

    .no-selection-message {
      text-align: center;
      color: #64748b;
      font-size: 0.9rem;
      padding: 2rem 1rem;
      font-style: italic;
    }

    .load-template-btn {
      background: #7c3aed;
      color: white;
      padding: 0.75rem 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      width: 100%;
      margin-bottom: 1rem;
    }

    .load-template-btn:hover {
      background: #6d28d9;
    }
  </style>
</head>
<body>
  <div class="editor-container">
    <div class="sidebar">
      <h2 style="margin-top: 0; color: var(--text-dark);">Certificate Editor</h2>
      
      <div class="form-group">
        <label for="certificate_type">Certificate Type</label>
        <select id="certificate_type">
          <option value="offer">Internship Offer</option>
          <option value="completion">Internship Completion</option>
        </select>
        <a href="#" class="preview-link" id="previewLink">Preview Default Template</a>
      </div>

      <button class="load-template-btn" onclick="loadPDFTemplate()">Load PDF Template</button>

      <div class="canvas-settings">
        <div class="section-title">Canvas Settings</div>
        <div class="canvas-size-controls">
          <input type="number" id="canvasWidth" placeholder="Width (px)" value="794">
          <input type="number" id="canvasHeight" placeholder="Height (px)" value="1123">
        </div>
        <div class="preset-sizes">
          <button class="preset-btn" onclick="setCanvasSize(794, 1123)">A4</button>
          <button class="preset-btn" onclick="setCanvasSize(1056, 816)">Letter</button>
          <button class="preset-btn" onclick="setCanvasSize(1200, 800)">Custom</button>
        </div>
        <button onclick="applyCanvasSize()" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer;">Apply Size</button>
      </div>

      <div class="form-group">
        <label for="backgroundUpload">Background Image</label>
        <input type="file" id="backgroundUpload" accept="image/*">
        <div class="background-preview" id="backgroundPreview">
          Click above to upload background image
        </div>
        <div class="background-fit-controls">
          <button class="fit-btn" onclick="setBackgroundFit('contain')" id="containBtn">Contain</button>
          <button class="fit-btn active" onclick="setBackgroundFit('cover')" id="coverBtn">Cover</button>
          <button class="fit-btn" onclick="setBackgroundFit('fill')" id="fillBtn">Fill</button>
          <button class="fit-btn" onclick="setBackgroundFit('none')" id="noneBtn">Original</button>
        </div>
      </div>

      <button class="add-text-btn" onclick="addTextElement()">+ Add Text Element</button>

      <!-- Text Formatting Panel (in Sidebar) -->
      <div class="text-formatting" id="textFormattingPanel">
        <div class="section-title">Text Formatting</div>
        
        <div class="selected-element-info" id="selectedElementInfo">
          Element selected - adjust formatting below
        </div>

        <div class="formatting-group">
          <span class="formatting-group-title">Style</span>
          <div class="button-group">
            <button class="format-btn" onclick="toggleBold()" id="boldBtn">Bold</button>
            <button class="format-btn" onclick="toggleItalic()" id="italicBtn">Italic</button>
            <button class="format-btn" onclick="toggleUnderline()" id="underlineBtn">Underline</button>
          </div>
        </div>

        <div class="formatting-group">
          <span class="formatting-group-title">Font</span>
          <div class="input-group">
            <select id="fontFamily" onchange="changeFontFamily()">
              <option value="Arial">Arial</option>
              <option value="Times New Roman">Times New Roman</option>
              <option value="Georgia">Georgia</option>
              <option value="Helvetica">Helvetica</option>
              <option value="Courier New">Courier New</option>
              <option value="Impact">Impact</option>
              <option value="Comic Sans MS">Comic Sans</option>
            </select>
          </div>
          <div class="input-group">
            <label>Size:</label>
            <input type="number" id="fontSize" value="16" min="8" max="72" onchange="changeFontSize()">
          </div>
        </div>

        <div class="formatting-group">
          <span class="formatting-group-title">Color & Opacity</span>
          <div class="color-opacity-group">
            <input type="color" id="textColor" class="color-input" value="#000000" onchange="changeTextColor()">
            <input type="range" id="opacity" class="opacity-slider" min="0" max="100" value="100" onchange="changeOpacity()">
          </div>
        </div>

        <div class="formatting-group">
          <span class="formatting-group-title">Alignment</span>
          <select id="textAlign" onchange="changeTextAlign()">
            <option value="left">Left</option>
            <option value="center">Center</option>
            <option value="right">Right</option>
            <option value="justify">Justify</option>
          </select>
        </div>
      </div>

      <div class="text-formatting show" id="noSelectionPanel">
        <div class="no-selection-message">
          Select a text element to edit its formatting
        </div>
      </div>

      <div class="layer-controls">
        <div class="section-title">Layer Controls</div>
        <button class="layer-btn" onclick="moveToFront()">Bring to Front</button>
        <button class="layer-btn" onclick="moveToBack()">Send to Back</button>
        <button class="layer-btn" onclick="duplicateElement()">Duplicate</button>
      </div>

      <div class="placeholder-section">
        <div class="section-title">Available Placeholder Tags</div>
        <div class="placeholder-grid" id="placeholderGrid">
          <!-- Placeholders will be generated here -->
        </div>
      </div>

      <div class="preview-section">
        
                <a href="#" class="btn cancel-btn" onclick="closeAndGoBack(); return false;">
    <i class="fas fa-arrow-left"></i> Back
</a>
              
        <button class="save-btn" onclick="saveTemplate()">Save Template</button>
      </div>
    </div>

    <div class="canvas-area" id="canvasArea">
      <div class="canvas-container">
        <div class="canvas" id="canvas">
          <!-- Text elements will be added here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Zoom controls -->
  <div class="zoom-controls">
    <button class="zoom-btn" onclick="zoomOut()">−</button>
    <div class="zoom-level" id="zoomLevel">100%</div>
    <button class="zoom-btn" onclick="zoomIn()">+</button>
    <button class="zoom-btn" onclick="resetZoom()" title="Reset Zoom">⌂</button>
  </div>

  <script>
    function closeAndGoBack() {
    window.close(); // This will close the current tab
}
    let selectedElement = null;
    let dragElement = null;
    let dragOffset = { x: 0, y: 0 };
    let resizeHandle = null;
    let elementCounter = 0;
    let zoomLevel = 1;
    let currentBackgroundFit = 'cover';

    const tagList = [
      '\x7B\x7B title \x7D\x7D', '\x7B\x7B student_name \x7D\x7D', '\x7B\x7B student_id \x7D\x7D', '\x7B\x7B course_name \x7D\x7D',
      '\x7B\x7B degree \x7D\x7D', '\x7B\x7B department \x7D\x7D', '\x7B\x7B college \x7D\x7D', '\x7B\x7B location \x7D\x7D',
      '\x7B\x7B start_date \x7D\x7D', '\x7B\x7B end_date \x7D\x7D', '\x7B\x7B duration \x7D\x7D', '\x7B\x7B completion_date \x7D\x7D', 
      '\x7B\x7B issue_date \x7D\x7D', '\x7B\x7B director_name \x7D\x7D', '\x7B\x7B credential_id \x7D\x7D'
    ];

    // Initialize placeholder buttons
    function initPlaceholders() {
      const grid = document.getElementById('placeholderGrid');
      tagList.forEach(tag => {
        const btn = document.createElement('div');
        btn.className = 'placeholder-btn';  
        btn.textContent = tag;
        btn.title = `Click to insert ${tag}`;
        btn.onclick = () => insertPlaceholder(tag);
        grid.appendChild(btn);
      });
    }

    // Load PDF template content with exact positioning and placeholders as normal text
    function loadPDFTemplate() {
      // Clear existing content
      document.getElementById('canvas').innerHTML = '';
      
      // Main content paragraph - placeholders displayed as normal text
      const mainContent = createTextElement(
        'This is to certify that <strong>\x7B\x7B title \x7D\x7D. \x7B\x7B student_name \x7D\x7D</strong> (\x7B\x7B student_id \x7D\x7D), a <strong>\x7B\x7B degree \x7D\x7D \x7B\x7B department \x7D\x7D</strong> student from <strong>\x7B\x7B college \x7D\x7D</strong>, has been permitted to undergo internship in the area of <strong>\x7B\x7B course_name \x7D\x7D</strong> at <strong>Pinesphere</strong> under our supervision and guidance.',
        80, 330
      );
      mainContent.style.width = '634px';
      mainContent.style.fontSize = '18px';
      mainContent.style.fontFamily = 'Times New Roman, serif';
      mainContent.style.lineHeight = '1.8';
      mainContent.style.textAlign = 'justify';
      mainContent.style.color = '#000';

      // Duration paragraph
      const durationContent = createTextElement(
        'The internship duration is from <strong>\x7B\x7B start_date \x7D\x7D</strong> to <strong>\x7B\x7B end_date \x7D\x7D</strong>.',
        80, 520
      );
      durationContent.style.width = '634px';
      durationContent.style.fontSize = '18px';
      durationContent.style.fontFamily = 'Times New Roman, serif';
      durationContent.style.lineHeight = '1.8';
      durationContent.style.color = '#000';

      // Footer signature section with more spacing
      const footerContent = createTextElement(
        'Yours sincerely,<br><br><br>For Pinesphere Solutions',
        80, 740
      );
      footerContent.style.width = '634px';
      footerContent.style.fontSize = '16px';
      footerContent.style.fontFamily = 'Times New Roman, serif';
      footerContent.style.lineHeight = '1.8';
      footerContent.style.color = '#000';

      // Director name and title with signature space
      const directorInfo = createTextElement(
        '<br><br>\x7B\x7B director_name \x7D\x7D<br><strong>Director</strong>',
        80, 860
      );
      directorInfo.style.width = '300px';
      directorInfo.style.fontSize = '16px';
      directorInfo.style.fontFamily = 'Times New Roman, serif';
      directorInfo.style.lineHeight = '1.8';
      directorInfo.style.color = '#000';

      // Certificate ID and issue date (right aligned)
      const issueDetails = createTextElement(
        'Certificate ID: \x7B\x7B credential_id \x7D\x7D<br><br><strong>Date of issue: \x7B\x7B issue_date \x7D\x7D</strong>',
        450, 880
      );
      issueDetails.style.width = '264px';
      issueDetails.style.fontSize = '16px';
      issueDetails.style.fontFamily = 'Times New Roman, serif';
      issueDetails.style.lineHeight = '1.6';
      issueDetails.style.textAlign = 'right';
      issueDetails.style.color = '#000';

      alert('PDF template load. Placeholders are now displayed as normal text and will be replaced.');
    }

    // Canvas size management
    function setCanvasSize(width, height) {
      document.getElementById('canvasWidth').value = width;
      document.getElementById('canvasHeight').value = height;
    }

    function applyCanvasSize() {
      const width = document.getElementById('canvasWidth').value;
      const height = document.getElementById('canvasHeight').value;
      const canvas = document.getElementById('canvas');
      
      if (width && height) {
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
      }
    }

    // Background image fit controls
    function setBackgroundFit(fitType) {
      const canvas = document.getElementById('canvas');
      currentBackgroundFit = fitType;
      
      // Remove active class from all buttons
      document.querySelectorAll('.fit-btn').forEach(btn => btn.classList.remove('active'));
      
      // Add active class to clicked button
      const activeBtn = {
        'contain': 'containBtn',
        'cover': 'coverBtn', 
        'fill': 'fillBtn',
        'none': 'noneBtn'
      };
      document.getElementById(activeBtn[fitType]).classList.add('active');
      
      // Apply background fit
      switch(fitType) {
        case 'contain':
          canvas.style.backgroundSize = 'contain';
          break;
        case 'cover':
          canvas.style.backgroundSize = 'cover';
          break;
        case 'fill':
          canvas.style.backgroundSize = '100% 100%';
          break;
        case 'none':
          canvas.style.backgroundSize = 'auto';
          break;
      }
    }

    // Zoom functionality
    function zoomIn() {
      if (zoomLevel < 3) {
        zoomLevel += 0.25;
        applyZoom();
      }
    }

    function zoomOut() {
      if (zoomLevel > 0.25) {
        zoomLevel -= 0.25;
        applyZoom();
      }
    }

    function resetZoom() {
      zoomLevel = 1;
      applyZoom();
    }

    function applyZoom() {
      const canvas = document.getElementById('canvas');
      canvas.style.transform = `scale(${zoomLevel})`;
      canvas.style.transformOrigin = 'top left';
      
      // Update zoom level display
      document.getElementById('zoomLevel').textContent = Math.round(zoomLevel * 100) + '%';
      
      // Adjust canvas container size to accommodate scaling
      const container = canvas.parentElement;
      container.style.width = (canvas.offsetWidth * zoomLevel) + 'px';
      container.style.height = (canvas.offsetHeight * zoomLevel) + 'px';
    }

    // Layer management
    function moveToFront() {
      if (selectedElement) {
        selectedElement.style.zIndex = (parseInt(selectedElement.style.zIndex || 1) + 100);
      }
    }

    function moveToBack() {
      if (selectedElement) {
        selectedElement.style.zIndex = Math.max(1, parseInt(selectedElement.style.zIndex || 1) - 100);
      }
    }

    function duplicateElement() {
      if (selectedElement) {
        const clone = selectedElement.cloneNode(true);
        clone.id = 'text-' + (++elementCounter);
        
        // Offset the duplicate slightly
        const left = parseInt(selectedElement.style.left) + 20;
        const top = parseInt(selectedElement.style.top) + 20;
        clone.style.left = left + 'px';
        clone.style.top = top + 'px';
        
        // Re-attach event listeners
        attachElementEvents(clone);
        
        document.getElementById('canvas').appendChild(clone);
        selectElement(clone);
      }
    }

    // Insert placeholder into selected text element
    function insertPlaceholder(tag) {
      if (selectedElement) {
        const selection = window.getSelection();
        if (selection.rangeCount > 0 && selectedElement.contains(selection.focusNode)) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          const textNode = document.createTextNode(tag);
          range.insertNode(textNode);
          range.collapse();
        } else {
          selectedElement.innerHTML += tag;
        }
      } else {
        const element = createTextElement(tag, 100, 100);
        selectElement(element);
      }
    }

    // Attach event listeners to element
    function attachElementEvents(element) {
      element.onmousedown = (e) => startDrag(e, element);
      element.onclick = (e) => {
        e.stopPropagation();
        selectElement(element);
      };
      element.ondblclick = (e) => {
        e.stopPropagation();
        enterEditMode(element);
      };
      element.oninput = () => updateSidebarToolbar();
      
      // Delete button
      const deleteBtn = element.querySelector('.delete-btn');
      if (deleteBtn) {
        deleteBtn.onclick = () => deleteElement(element);
      }
      
      // Resize handles
      element.querySelectorAll('.resize-handle').forEach(handle => {
        const pos = handle.className.split(' ')[1];
        handle.onmousedown = (e) => startResize(e, element, pos);
      });
    }

    // Create new text element
    function createTextElement(text = "Click to edit text", x = 100, y = 100) {
      const canvas = document.getElementById('canvas');
      const element = document.createElement('div');
      element.className = 'text-element';
      element.contentEditable = true;
      element.innerHTML = text;
      element.id = 'text-' + (++elementCounter);
      
      element.style.left = x + 'px';
      element.style.top = y + 'px';
      element.style.fontSize = '16px';
      element.style.fontFamily = 'Arial';
      element.style.color = '#000000';
      element.style.zIndex = '1';

      // Add delete button
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'delete-btn';
      deleteBtn.innerHTML = '×';
      element.appendChild(deleteBtn);

      // Add resize handles
      ['nw', 'ne', 'sw', 'se'].forEach(pos => {
        const handle = document.createElement('div');
        handle.className = `resize-handle ${pos}`;
        element.appendChild(handle);
      });

      // Attach event listeners
      attachElementEvents(element);

      canvas.appendChild(element);
      return element;
    }

    // Add text element button handler
    function addTextElement() {
      const element = createTextElement('{{ student_name }}', 100, 100);
      selectElement(element);
    }

    // Select element and show sidebar toolbar
    function selectElement(element) {
      if (selectedElement) {
        selectedElement.classList.remove('selected');
        selectedElement.classList.remove('editing');
      }
      
      selectedElement = element;
      element.classList.add('selected');
      updateSidebarToolbar();
      showSidebarToolbar();
    }

    // Enter edit mode
    function enterEditMode(element) {
      element.classList.add('editing');
      element.focus();
      
      // Select all text content, excluding buttons and handles
      const range = document.createRange();
      const textNodes = [];
      
      function getTextNodes(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          textNodes.push(node);
        } else if (node.nodeType === Node.ELEMENT_NODE && 
                  !node.classList.contains('delete-btn') && 
                  !node.classList.contains('resize-handle')) {
          for (let child of node.childNodes) {
            getTextNodes(child);
          }
        }
      }
      
      getTextNodes(element);
      
      if (textNodes.length > 0) {
        range.setStartBefore(textNodes[0]);
        range.setEndAfter(textNodes[textNodes.length - 1]);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }

    // Delete element
    function deleteElement(element) {
      if (selectedElement === element) {
        hideSidebarToolbar();
        selectedElement = null;
      }
      element.remove();
    }

    // Drag functionality
    function startDrag(e, element) {
      if (e.target.classList.contains('resize-handle') || e.target.classList.contains('delete-btn')) {
        return;
      }
      
      dragElement = element;
      const rect = element.getBoundingClientRect();
      const canvasRect = document.getElementById('canvas').getBoundingClientRect();
      
      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;
      
      e.preventDefault();
    }

    // Resize functionality
    function startResize(e, element, handle) {
      resizeHandle = { element, handle, startX: e.clientX, startY: e.clientY };
      e.preventDefault();
      e.stopPropagation();
    }

    // Mouse move handler
    document.onmousemove = (e) => {
      if (dragElement) {
        const canvasRect = document.getElementById('canvas').getBoundingClientRect();
        const newX = (e.clientX - canvasRect.left) / zoomLevel - dragOffset.x / zoomLevel;
        const newY = (e.clientY - canvasRect.top) / zoomLevel - dragOffset.y / zoomLevel;
        
        dragElement.style.left = Math.max(0, Math.min(newX, canvasRect.width / zoomLevel - dragElement.offsetWidth)) + 'px';
        dragElement.style.top = Math.max(0, Math.min(newY, canvasRect.height / zoomLevel - dragElement.offsetHeight)) + 'px';
      }
      
      if (resizeHandle) {
        const { element, handle, startX, startY } = resizeHandle;
        const deltaX = (e.clientX - startX) / zoomLevel;
        const deltaY = (e.clientY - startY) / zoomLevel;
        
        const rect = element.getBoundingClientRect();
        const canvasRect = document.getElementById('canvas').getBoundingClientRect();
        
        let newWidth = element.offsetWidth;
        let newHeight = element.offsetHeight;
        let newLeft = parseInt(element.style.left);
        let newTop = parseInt(element.style.top);
        
        if (handle.includes('e')) newWidth += deltaX;
        if (handle.includes('w')) {
          newWidth -= deltaX;
          newLeft += deltaX;
        }
        if (handle.includes('s')) newHeight += deltaY;
        if (handle.includes('n')) {
          newHeight -= deltaY;
          newTop += deltaY;
        }
        
        if (newWidth > 50 && newHeight > 20) {
          element.style.width = newWidth + 'px';
          element.style.height = newHeight + 'px';
          element.style.left = Math.max(0, newLeft) + 'px';
          element.style.top = Math.max(0, newTop) + 'px';
        }
        
        resizeHandle.startX = e.clientX;
        resizeHandle.startY = e.clientY;
      }
    };

    // Mouse up handler
    document.onmouseup = () => {
      dragElement = null;
      resizeHandle = null;
    };

    // Canvas click handler
    document.getElementById('canvas').onclick = (e) => {
      if (e.target === e.currentTarget) {
        if (selectedElement) {
          selectedElement.classList.remove('selected');
          selectedElement.classList.remove('editing');
          selectedElement = null;
          hideSidebarToolbar();
        }
      }
    };

    // Sidebar Toolbar functions
    function showSidebarToolbar() {
      document.getElementById('textFormattingPanel').classList.add('show');
      document.getElementById('noSelectionPanel').classList.remove('show');
      
      // Update element info
      const info = document.getElementById('selectedElementInfo');
      if (selectedElement) {
        info.textContent = `Element #${selectedElement.id} selected - adjust formatting below`;
      }
    }

    function hideSidebarToolbar() {
      document.getElementById('textFormattingPanel').classList.remove('show');
      document.getElementById('noSelectionPanel').classList.add('show');
    }

    function updateSidebarToolbar() {
      if (!selectedElement) return;
      
      const style = window.getComputedStyle(selectedElement);
      
      // Update toolbar controls
      document.getElementById('fontFamily').value = style.fontFamily.replace(/"/g, '').split(',')[0];
      document.getElementById('fontSize').value = parseInt(style.fontSize);
      document.getElementById('textColor').value = rgbToHex(style.color);
      document.getElementById('textAlign').value = style.textAlign;
      
      // Update opacity slider
      const opacity = style.opacity ? Math.round(parseFloat(style.opacity) * 100) : 100;
      document.getElementById('opacity').value = opacity;
      
      // Update button states
      document.getElementById('boldBtn').classList.toggle('active', style.fontWeight === 'bold' || parseInt(style.fontWeight) >= 700);
      document.getElementById('italicBtn').classList.toggle('active', style.fontStyle === 'italic');
      document.getElementById('underlineBtn').classList.toggle('active', style.textDecoration.includes('underline'));
    }

    function toggleBold() {
      document.execCommand('bold');
      updateSidebarToolbar();
    }

    function toggleItalic() {
      document.execCommand('italic');
      updateSidebarToolbar();
    }

    function toggleUnderline() {
      document.execCommand('underline');
      updateSidebarToolbar();
    }

    function changeFontFamily() {
      if (selectedElement) {
        selectedElement.style.fontFamily = document.getElementById('fontFamily').value;
      }
    }

    function changeFontSize() {
      if (selectedElement) {
        selectedElement.style.fontSize = document.getElementById('fontSize').value + 'px';
      }
    }

    function changeTextColor() {
      if (selectedElement) {
        selectedElement.style.color = document.getElementById('textColor').value;
      }
    }

    function changeTextAlign() {
      if (selectedElement) {
        selectedElement.style.textAlign = document.getElementById('textAlign').value;
      }
    }

    function changeOpacity() {
      if (selectedElement) {
        const opacity = document.getElementById('opacity').value / 100;
        selectedElement.style.opacity = opacity;
      }
    }

    // Background image upload with enhanced features
    document.getElementById('backgroundUpload').onchange = function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const canvas = document.getElementById('canvas');
          const preview = document.getElementById('backgroundPreview');
          
          canvas.style.backgroundImage = `url(${e.target.result})`;
          preview.style.backgroundImage = `url(${e.target.result})`;
          preview.textContent = '';
          
          // Apply current background fit setting
          setBackgroundFit(currentBackgroundFit);
          
          // Get image dimensions for canvas sizing suggestions
          const img = new Image();
          img.onload = function() {
            // Suggest canvas size based on image dimensions
            if (img.width && img.height) {
              const aspectRatio = img.width / img.height;
              let suggestedWidth, suggestedHeight;
              
              if (aspectRatio > 1) {
                // Landscape
                suggestedWidth = Math.min(1200, img.width);
                suggestedHeight = Math.round(suggestedWidth / aspectRatio);
              } else {
                // Portrait
                suggestedHeight = Math.min(1400, img.height);
                suggestedWidth = Math.round(suggestedHeight * aspectRatio);
              }
              
              // Update input fields with suggestions
              document.getElementById('canvasWidth').placeholder = `Suggested: ${suggestedWidth}px`;
              document.getElementById('canvasHeight').placeholder = `Suggested: ${suggestedHeight}px`;
            }
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    };

    // Save template with enhanced data
   function saveTemplate() {
    const canvas = document.getElementById('canvas');
    const certificateType = document.getElementById('certificate_type').value;

    // Capture the HTML content (background + positioned text elements)
    const templateHTML = canvas.outerHTML;

    fetch("{% url 'save_certificate_template' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
            certificate_type: certificateType,
            html_content: templateHTML
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            alert("Template saved successfully!");
            closeAndGoBack(); // closes the tab
        } else {
            alert("Error: " + data.message);
        }
    })
    .catch(error => {
        console.error('Error saving template:', error);
        alert('Failed to save template. Check console for details.');
    });
}

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (selectedElement) {
        // Delete key
        if (e.key === 'Delete' && !selectedElement.classList.contains('editing')) {
          deleteElement(selectedElement);
          e.preventDefault();
        }
        
        // Copy (Ctrl+C)
        if (e.ctrlKey && e.key === 'c') {
          // Store element data for copying
          window.clipboardElement = {
            content: selectedElement.innerHTML.replace(/<button[^>]*>.*?<\/button>/g, '').replace(/<div class="resize-handle[^>]*><\/div>/g, ''),
            style: {
              fontSize: selectedElement.style.fontSize,
              fontFamily: selectedElement.style.fontFamily,
              color: selectedElement.style.color,
              textAlign: selectedElement.style.textAlign,
              fontWeight: selectedElement.style.fontWeight,
              fontStyle: selectedElement.style.fontStyle,
              textDecoration: selectedElement.style.textDecoration,
              opacity: selectedElement.style.opacity
            }
          };
          e.preventDefault();
        }
        
        // Paste (Ctrl+V)
        if (e.ctrlKey && e.key === 'v' && window.clipboardElement) {
          const newElement = createTextElement(window.clipboardElement.content, 120, 120);
          Object.assign(newElement.style, window.clipboardElement.style);
          selectElement(newElement);
          e.preventDefault();
        }
        
        // Arrow keys for fine positioning
        if (!selectedElement.classList.contains('editing')) {
          const step = e.shiftKey ? 10 : 1;
          let moved = false;
          
          switch(e.key) {
            case 'ArrowUp':
              selectedElement.style.top = Math.max(0, parseInt(selectedElement.style.top) - step) + 'px';
              moved = true;
              break;
            case 'ArrowDown':
              selectedElement.style.top = (parseInt(selectedElement.style.top) + step) + 'px';
              moved = true;
              break;
            case 'ArrowLeft':
              selectedElement.style.left = Math.max(0, parseInt(selectedElement.style.left) - step) + 'px';
              moved = true;
              break;
            case 'ArrowRight':
              selectedElement.style.left = (parseInt(selectedElement.style.left) + step) + 'px';
              moved = true;
              break;
          }
          
          if (moved) {
            e.preventDefault();
          }
        }
      }
      
      // Global shortcuts
      if (e.ctrlKey && e.key === 's') {
        saveTemplate();
        e.preventDefault();
      }
    });

    // Utility functions
    function rgbToHex(rgb) {
      const result = rgb.match(/\d+/g);
      if (!result) return '#000000';
      return '#' + result.map(x => parseInt(x).toString(16).padStart(2, '0')).join('');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initPlaceholders();
      
      // Show no selection panel initially
      hideSidebarToolbar();
    });
  </script>
</body>
</html>