{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Pinesphere | Coordinator Dashboard</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/r2xvtYsR/logo-removebg-preview.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary-color: #3794D0;
            --primary-dark: #026aaf;
            --secondary-color: #f8fafc;
            --text-color: #1e293b;
            --text-color-light: #64748b;
            --light-gray: #e2e8f0;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .dashboard-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 2rem;
        }

        .logout-btn {
            background-color: #3794D0;
            text-decoration: none !important;
            font-size: 14px;
            font-weight: 500;
            padding: 0.60rem 1.5rem;
            color: white;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: none;
            cursor: pointer;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .navbar {
            font-family: 'Poppins', sans-serif;
        }

        .logout-btn:hover {
            background-color: #b61a1a;
            transform: translateY(-3px);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .welcome-message h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .welcome-message p {
            color: var(--text-color-light);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-btn {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
            font-weight: 500;
        }

        .action-btn i {
            margin-right: 0.5rem;
        }

        .action-btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .data-section {
            background-color: var(--white);
            border-radius: 0.5rem;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th {
            text-align: left;
            padding: 1rem;
            background-color: var(--light-gray);
            font-weight: 500;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-color-light);
        }

        /* Certificate Form (hidden by default) */
        .certificate-form {
            display: none;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: var(--light-gray);
            border-radius: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
            font-family: 'Poppins', sans-serif;
        }

        .form-actions {
            margin-top: 1rem;
            text-align: right;
        }

        /* Footer */
        .dashboard-footer {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: solid rgba(0, 0, 0, 0.301);
        }

        .footer-section h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .footer-section ul {
            list-style: none;
        }

        .footer-section li {
            margin-bottom: 0.5rem;
        }

        .footer-section a {
            color: var(--text-color);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer-section a:hover {
            color: var(--primary-color);
        }

        .copyright {
            text-align: center;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
            color: var(--text-color-light);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 1rem;
            }

            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Error message styling */
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Signature preview */
        .signature-preview {
            max-width: 200px;
            max-height: 100px;
            margin-top: 0.5rem;
            display: none;
        }

        /* Offer Form Specific Styling */
        #offerForm .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        #offerForm .form-group {
            flex: 1;
            min-width: 200px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        .pagination a,
        .pagination span {
            padding: 0.4rem 0.9rem;
            border-radius: 0.6rem;
            background-color: var(--background);
            color: var(--text-dark);
            text-decoration: none;
            font-weight: 500;
            border: 1px solid var(--border-color);
            transition: var(--transition);
            box-shadow: var(--shadow);
        }

        .pagination a:hover {
            background-color: var(--primary-color);
            color: #fff;
            border-color: var(--primary-dark);
        }

        .pagination .current {
            background-color: var(--primary-dark);
            color: white;
            font-weight: 600;
            pointer-events: none;
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="welcome-message">
                <h1>Welcome back, Coordinator</h1>
                <p>Here's your certificate management dashboard</p>
            </div>
            <div style="display: flex; justify-content: flex-end;">
                <a href="{% url 'index' %}" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </header>

        <div class="action-buttons">
            <button class="action-btn" id="showOfferForm">
                <i class="fas fa-file-signature"></i> Generate Offer Letter
            </button>
            <button class="action-btn" id="showCompletionForm">
                <i class="fas fa-award"></i> Generate Completion Certificate
            </button>
            <!-- <button class="action-btn" id="showStudentForm">
                <i class="fas fa-user-plus"></i> Add Student
            </button> -->
            <button class="action-btn" id="showBulkUploadForm">
                <i class="fas fa-upload"></i> Bulk Upload
            </button>
        </div>

        <!-- Completion Certificate Form -->
        <div class="certificate-form" id="completionForm">
            <div class="data-section">
                <h3>Generate Completion Certificate</h3>
                <form id="createCompletionForm">
                    <!-- Title, Name and Register Number -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="completionTitle">Title</label>
                            <select id="completionTitle" name="completionTitle" required>
                                <option value="">Select Title</option>
                                <option value="Mr">Mr</option>
                                <option value="Ms">Ms</option>
                                <option value="Mrs">Mrs</option>
                                <option value="Dr">Dr</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="completionStudentName">Student Name</label>
                            <input type="text" id="completionStudentName" name="completionStudentName" required>
                        </div>
                        <div class="form-group">
                            <label for="completionRegisterNumber">Register Number</label>
                            <input type="text" id="completionRegisterNumber" name="completionRegisterNumber" required>
                        </div>
                    </div>

                    <!-- Degree and College -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="completionDegree">Degree</label>
                            <select id="completionDegree" name="completionDegree" required
                                onchange="populateDepartments('completionDegree', 'completionDepartment')">
                                <option value="">Select Degree</option>
                                <option value="B.E">Bachelor's of Engineering</option>
                                <option value="B.Tech">B Tech</option>
                                <option value="B.Sc">B.Sc (Science)</option>
                                <option value="B.A">B.A (Arts)</option>
                                <option value="MBA">MBA</option>
                                <option value="Diploma">Diploma</option>
                            </select>
                        </div>
                        <div class="form-group" id="completionDepartmentGroup" style="display:none;">
                            <label for="completionDepartment">Department</label>
                            <select id="completionDepartment" name="completionDepartment" required>
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="completionCollege">College</label>
                            <input type="text" id="completionCollege" name="completionCollege" required>
                        </div>
                    </div>

                    <!-- Location and Course -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="completionLocation">Location</label>
                            <input type="text" id="completionLocation" name="completionLocation">
                        </div>
                        <div class="form-group">
                            <label for="completionCourseName">Course/Domain</label>
                            <input type="text" id="completionCourseName" name="completionCourseName" required>
                        </div>
                    </div>

                    <!-- Project Field  -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="completionProject">Project Name</label>
                            <input type="text" id="completionProject" name="completionProject"
                                placeholder="e.g., Online Portfolio System">
                        </div>
                    </div>

                    <!-- Start Date, End Date, Duration -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="completionStartDate">Start Date</label>
                            <input type="date" id="completionStartDate" name="completionStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="completionEndDate">End Date</label>
                            <input type="date" id="completionEndDate" name="completionEndDate" required>
                        </div>
                        <div class="form-group">
                            <label for="completionDuration">Duration</label>
                            <input type="text" id="completionDuration" name="completionDuration"
                                placeholder="e.g., 2 weeks" required>
                        </div>
                    </div>

                    <!-- Director -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="completionDirector">Director Name</label>
                            <select id="completionDirector" name="completionDirector" required>
                                <option value="">Select Director</option>
                                <option value="Mr. Surendiran S">Mr. Surendiran S</option>
                                <option value="Mr. Vasanth Nagarajan ">Mr. Vasanth Nagarajan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="completionIssueDate">Date of Issue</label>
                            <input type="date" id="completionIssueDate" name="completionIssueDate" required>
                        </div>
                    </div>



                    <!-- Submit -->
                    <div class="form-actions">
                        <button type="submit" class="action-btn">
                            <i class="fas fa-save"></i> Generate Certificate
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Student Form -->
        <div class="certificate-form" id="addstudentForm">
            <div class="data-section">
                <h3>Add New Student</h3>
                <form id="addStudentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newStudentName">Full Name</label>
                            <input type="text" id="newStudentName" name="student_name" required>
                        </div>
                        <div class="form-group">
                            <label for="newStudentEmail">Email</label>
                            <input type="email" id="newStudentEmail" name="student_email" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newStudentID">Register Number</label>
                            <input type="text" id="newStudentID" name="student_id" required>
                        </div>
                        <div class="form-group">
                            <label for="newDepartment">Department</label>
                            <input type="text" id="newDepartment" name="student_department" required>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="action-btn">
                            <i class="fas fa-save"></i> Add Student
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!--Bulk Generation-->
        <div class="certificate-form" id="bulkUploadForm" style="display: none;">
            <div class="data-section">
                <h3>Bulk Upload Certificates</h3>
                <form id="bulkOfferUploadForm" enctype="multipart/form-data">
                    <input type="file" name="csvFile" accept=".csv, .xls, .xlsx" required>
                    <button type="submit" class="action-btn">Upload Offer Letters</button>
                </form>
                <br>
                <form id="bulkCompletionUploadForm" enctype="multipart/form-data">
                    <input type="file" name="csvFile" accept=".csv, .xls, .xlsx" required>
                    <button type="submit" class="action-btn">Upload Completion Certificates</button>
                </form>
            </div>
        </div>
        <!-- Offer Letter Form -->
        <div class="certificate-form" id="offerForm">
            <div class="data-section">
                <h3>Generate Offer Letter</h3>
                <form id="createOfferForm" enctype="multipart/form-data">
                    <!-- Title, Name and Register Number in one line -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="offerTitle">Title</label>
                            <select id="offerTitle" name="offerTitle" required>
                                <option value="">Select Title</option>
                                <option value="Mr">Mr</option>
                                <option value="Ms">Ms</option>
                                <option value="Mrs">Mrs</option>
                                <option value="Dr">Dr</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="offerStudentName">Student Name</label>
                            <input type="text" id="offerStudentName" name="offerStudentName" required>
                        </div>
                        <div class="form-group">
                            <label for="offerRegisterNumber">Register Number</label>
                            <input type="text" id="offerRegisterNumber" name="offerRegisterNumber" required>
                        </div>
                    </div>

                    <!-- Degree and College in one line -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="offerDegree">Degree</label>
                            <select id="offerDegree" name="offerDegree" required
                                onchange="populateDepartments('offerDegree', 'offerDepartment')">
                                <option value="">Select Degree</option>
                                <option value="B.E">Bachelor's of Engineering</option>
                                <option value="B.Tech">B Tech</option>
                                <option value="B.Sc">B.Sc (Science)</option>
                                <option value="B.A">B.A (Arts)</option>
                                <option value="MBA">MBA</option>
                                <option value="Diploma">Diploma</option>
                            </select>
                        </div>
                        <div class="form-group" id="offerDepartmentGroup" style="display:none;">
                            <label for="offerDepartment">Department</label>
                            <select id="offerDepartment" name="offerDepartment" required>
                                <option value="">Select Department</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="offerCollege">College</label>
                            <input type="text" id="offerCollege" name="offerCollege" required>
                        </div>
                    </div>

                    <!-- Location and Domain in one line -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="offerLocation">Location</label>
                            <input type="text" id="offerLocation" name="offerLocation">
                        </div>
                        <div class="form-group">
                            <label for="offerCourseName">Domain</label>
                            <input type="text" id="offerCourseName" name="offerCourseName" required>
                        </div>
                    </div>

                    <!-- Start Date, End Date and Duration in one line -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="offerStartDate">Start Date</label>
                            <input type="date" id="offerStartDate" name="offerStartDate" required>
                        </div>
                        <div class="form-group">
                            <label for="offerEndDate">End Date</label>
                            <input type="date" id="offerEndDate" name="offerEndDate" required>
                        </div>
                        <div class="form-group">
                            <label for="offerDuration">Duration</label>
                            <input type="text" id="offerDuration" name="offerDuration" placeholder="e.g., 6 months"
                                required>
                        </div>
                    </div>

                    <!-- Director Name and E-sign in one line -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="offerDirector">Director Name</label>
                            <select id="offerDirector" name="offerDirector" required>
                                <option value="">Select Director</option>
                                <option value="Mr. Surendiran S">Mr. Surendiran S</option>
                                <option value="Mr. Vasanth Nagarajan ">Mr. Vasanth Nagarajan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="offerIssueDate">Date of Issue</label>
                            <input type="date" id="offerIssueDate" name="offerIssueDate" required>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="form-actions">
                        <button type="submit" class="action-btn">
                            <i class="fas fa-save"></i> Generate Certificate
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- Filter & Search -->
        <form method="get" style="margin-bottom: 1.5rem;">
            <div class="form-row">
                <!-- Filter by Type -->
                <div class="form-group">
                    <label>Filter by Type</label>
                    <select name="type" style="padding: 0.5rem; border-radius: 8px; border: 1px solid #ccc;">
                        <option value="">All Types</option>
                        <option value="offer" {% if request.GET.type=='offer' %} selected {% endif %}>Offer Letter
                        </option>
                        <option value="completion" {% if request.GET.type=='completion' %} selected {% endif %}>
                            Completion
                            Certificate</option>
                    </select>
                </div>

                <!-- Student Name -->
                <div class="form-group">
                    <label>Student Name</label>
                    <input type="text" name="student_name" placeholder="Search by Student Name"
                        value="{{ request.GET.student_name }}"
                        style="padding: 0.5rem; border-radius: 8px; border: 1px solid #ccc;">
                </div>

                <!-- Course / Domain -->
                <div class="form-group">
                    <label>Course / Domain</label>
                    <input type="text" name="course_name" placeholder="Search by Course/Domain"
                        value="{{ request.GET.course_name }}"
                        style="padding: 0.5rem; border-radius: 8px; border: 1px solid #ccc;">
                </div>

                <!-- Buttons -->
                <div class="form-group" style="display: flex; align-items: flex-end; gap: 1rem;">
                    <button type="submit" class="action-btn"><i class="fas fa-search"></i> Search</button>
                    <a style="text-decoration: none; padding: 0.55rem 1.5rem; " href="{% url 'coordinator_dashboard' %}"
                        class="action-btn"><i class="fas fa-sync-alt"></i> Reset</a>
                </div>
            </div>
        </form>


        <!-- Certificates Table -->
        <div class="data-section">
            <h2 class="section-title">
                <i class="fas fa-certificate"></i> Students Certificates
            </h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STUDENT</th>
                        <th>COURSE</th>
                        <th>DATE</th>
                        <th>CERTIFICATE ID</th>
                        <th>TYPE</th>
                        <th>ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    {% if certificates %}
                    {% for cert in certificates %}
                    <tr>
                        <td>{{ cert.student_name }}</td>
                        <td>{{ cert.course_name }}</td>
                        <td>{{ cert.completion_date|date:"Y-m-d" }}</td>
                        <td>{{ cert.certificate_number }}</td>
                        <td>{{ cert.get_certificate_type_display }}</td>
                        <td>
                            {% if cert.generated_pdf %}
                            <a style="text-decoration: none;" href="{{ cert.generated_pdf.url }}" class="action-btn"
                                download>Download</a>
                            {% else %}
                            <span class="action-btn disabled">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="6" class="empty-state">No certificates created yet</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Pagination of the form -->
        {% if page_obj.has_other_pages %}
        {% with query_params=request.GET.urlencode %}
        <div style="text-align:center; margin-top: 1.5rem;">
            <div class="pagination" style="display: flex; justify-content: center; align-items: center; gap: 1rem;">

                {% if page_obj.has_previous %}
                <a href="?{% if query_params %}{{ query_params }}&{% endif %}page={{ page_obj.previous_page_number }}"
                    class="action-btn">
                    <i class="fas fa-angle-left"></i> Previous
                </a>
                {% endif %}

                <span class="page-info" style="font-weight: 500;">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                <a href="?{% if query_params %}{{ query_params }}&{% endif %}page={{ page_obj.next_page_number }}"
                    class="action-btn">
                    Next <i class="fas fa-angle-right"></i>
                </a>
                {% endif %}

            </div>
        </div>
        {% endwith %}
        {% endif %}


        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="footer-section">
                <h3>Pinesphere Solutions</h3>
                <p>Empowering education through digital certificates. Create, manage, and distribute professional
                    certificates with ease.</p>
            </div>

            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="{% url 'index' %}">Home</a></li>
                    <li><a href="{% url 'about' %}">About us</a></li>
                    <li><a href="{% url 'contact' %}">Contact</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contact Info</h3>
                <ul>
                    <li><i class="fas fa-envelope"></i> pinespheresolutions144@gmil.com</li>
                    <li><i class="fas fa-phone"></i> +91 94436 71149</li>
                    <li><i class="fas fa-map-marker-alt"></i> 1ˢᵗ Floor, C block, NGP Institutions Campus, Kalapatti
                        Main Rd, Sharp Nagar, Nehru Nagar West, Coimbatore, Tamil Nadu 641048</li>
                </ul>
            </div>
        </footer>

        <div class="copyright">
            <p>&copy; 2025 Pinephere Solutions Private Limited</p>
        </div>
    </div>

    <script>
        setInterval(() => {
            fetch('/accounts/ping/');
        }, 5 * 60 * 1000);
        const departmentData = {
            "B.E": [
                "Computer Science and Engineering", "AI & DS",
                "Mechanical Engineering",
                "Electrical Engineering",
                "Civil Engineering",
                "Electronics and Communication",
                "Electronics and Instrumentation Engineering",
                "Mechatronics",
                "Automobile Engineering",
                "Robotics and Automation",
                "Aeronautical Engineering",
                "Marine Engineering",
                "Mining Engineering",
                "Production Engineering",
                "Biomedical Engineering"
            ],
            "B.Tech": [
                "Information Technology",
                "AI & DS",
                "Biotechnology",
                "Chemical Engineering",
                "Food Technology",
                "Petroleum Engineering",
                "Textile Technology",
                "Agricultural Engineering",
                "Nanotechnology",
                "Cyber Security",
                "Data Science",
                "Artificial Intelligence and Machine Learning"
            ],
            "B.Sc": [
                "Computer Science",
                "Mathematics",
                "Physics",
                "Chemistry",
                "Biochemistry",
                "Botany",
                "Zoology",
                "Microbiology",
                "Biotechnology",
                "Information Technology",
                "Electronics"
            ],
            "B.A": [
                "English Literature",
                "History",
                "Economics",
                "Sociology",
                "Political Science",
                "Psychology",
                "Tamil Literature",
                "Public Administration",
                "Philosophy",
                "Visual Communication",
                "Journalism and Mass Communication"
            ],
            "MBA": [
                "Finance",
                "Marketing",
                "Human Resource Management",
                "Operations Management",
                "International Business"
            ],
            "Diploma": [
                "Computer Engineering",
                "Mechanical Engineering",
                "Civil Engineering",
                "Electrical and Electronics Engineering",
                "Electronics and Communication Engineering"
            ]
        };

        function populateDepartments(degreeId, departmentId) {
            const degree = document.getElementById(degreeId).value;
            const department = document.getElementById(departmentId);
            const departmentGroup = document.getElementById(departmentId + 'Group');
            department.innerHTML = '<option value="">Select Department</option>';

            if (departmentData[degree]) {
                departmentData[degree].forEach(opt => {
                    const option = document.createElement("option");
                    option.value = opt;
                    option.textContent = opt;
                    department.appendChild(option);
                });
                departmentGroup.style.display = "block";
                department.required = true;
            } else {
                departmentGroup.style.display = "none";
                department.required = false;
            }
        }

        function checkImageSize(input) {
            const errorElement = document.getElementById(input.id + 'Error');
            const previewElement = document.getElementById(input.id + 'Preview');
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const img = new Image();
                const objectURL = URL.createObjectURL(file);
                img.onload = function () {
                    const megapixels = (this.width * this.height) / 1000000;
                    if (megapixels > 2) {
                        errorElement.textContent = 'Image exceeds 2MP limit.';
                        input.value = '';
                        previewElement.style.display = 'none';
                    } else {
                        errorElement.textContent = '';
                        previewElement.src = objectURL;
                        previewElement.style.display = 'block';
                    }
                    URL.revokeObjectURL(objectURL);
                };
                img.src = objectURL;
            }
        }

        function showPopup(message, success = true) {
            let popup = document.getElementById('popupNotification');
            if (!popup) {
                popup = document.createElement('div');
                popup.id = 'popupNotification';
                popup.style.position = 'fixed';
                popup.style.top = '20px';
                popup.style.right = '20px';
                popup.style.zIndex = '9999';
                popup.style.padding = '12px 20px';
                popup.style.borderRadius = '6px';
                popup.style.color = 'white';
                popup.style.fontWeight = 'bold';
                document.body.appendChild(popup);
            }
            popup.style.backgroundColor = success ? '#4BB543' : '#FF3333';
            popup.textContent = message;
            popup.style.display = 'block';
            setTimeout(() => { popup.style.display = 'none'; }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function () {
            const showOfferForm = document.getElementById('showOfferForm');
            const showCompletionForm = document.getElementById('showCompletionForm');
            const showStudentForm = document.getElementById('showStudentForm');
            const showBulkUploadForm = document.getElementById('showBulkUploadForm');
            const offerForm = document.getElementById('offerForm');
            const completionForm = document.getElementById('completionForm');
            const studentForm = document.getElementById('addstudentForm');
            const bulkUploadForm = document.getElementById('bulkUploadForm');
            const tableBody = document.querySelector('.data-table tbody');

            function hideAllForms() {
                offerForm.style.display = 'none';
                completionForm.style.display = 'none';
                studentForm.style.display = 'none';
                bulkUploadForm.style.display = 'none';
            }

            hideAllForms();

            showOfferForm?.addEventListener('click', () => {
                hideAllForms();
                offerForm.style.display = 'block';
            });

            showCompletionForm?.addEventListener('click', () => {
                hideAllForms();
                completionForm.style.display = 'block';
            });

            showStudentForm?.addEventListener('click', () => {
                hideAllForms();
                studentForm.style.display = 'block';
            });

            showBulkUploadForm?.addEventListener('click', () => {
                hideAllForms();
                bulkUploadForm.style.display = 'block';
            });

            function addCertificateToTable(student, course, date, certId, type, downloadUrl) {
                const emptyRow = document.querySelector('.empty-state');
                if (emptyRow) emptyRow.remove();
                const row = document.createElement('tr');
                row.innerHTML = `
                <td>${student}</td>
                <td>${course}</td>
                <td>${date}</td>
                <td>${certId}</td>
                <td>${type}</td>
                <td>
                    ${downloadUrl ? `<a href="${downloadUrl}" class="action-btn" download>Download</a>` : '<span class="action-btn disabled">N/A</span>'}
                </td>`;
                tableBody.appendChild(row);
            }

            function handleCertificateSubmit(formId, url, type) {
                const form = document.getElementById(formId);
                form?.addEventListener('submit', function (e) {
                    e.preventDefault();
                    const formData = new FormData(form);

                    // Common validation rules
                    const alphaRegex = /^[A-Za-z\s]+$/; // Letters + spaces
                    const domainRegex = /^[A-Za-z0-9\s.,-]+$/; // Letters, numbers, spaces, dots, commas, hyphens

                    // 1️⃣ Student Name Validation
                    const nameInput = form.querySelector('[name$="StudentName"], [name="student_name"]');
                    if (nameInput) {
                        const value = nameInput.value.trim();
                        if (!alphaRegex.test(value)) {
                            showPopup('Only letters and spaces allowed in student name.', false);
                            return;
                        }
                    }



                    // 3️⃣ Location Validation
                    const locationInput = form.querySelector('[name$="Location"]');
                    if (locationInput) {
                        const value = locationInput.value.trim();
                        if (value && !alphaRegex.test(value)) {
                            showPopup('Only letters and spaces allowed in location field.', false);
                            return;
                        }
                    }

                    // 4️⃣ Course/Domain Validation
                    const domainInput = form.querySelector('[name$="CourseName"]');
                    if (domainInput) {
                        const value = domainInput.value.trim();
                        if (!domainRegex.test(value)) {
                            showPopup('Only letters, numbers, spaces, and basic punctuation allowed in domain.', false);
                            return;
                        }
                    }

                    // 5️⃣ Student Department Validation
                    const departmentInput = form.querySelector('[name="student_department"]');
                    if (departmentInput) {
                        const value = departmentInput.value.trim();
                        if (!alphaRegex.test(value)) {
                            showPopup('Only letters and spaces allowed in department field.', false);
                            return;
                        }
                    }

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData
                    })
                        .then(response => {
                            if (!response.ok) throw new Error('Server error. Please check the form.');
                            return response.json();
                        })
                        .then(data => {
                            if (data.status === 'success') {
                                addCertificateToTable(
                                    data.student,
                                    data.course,
                                    data.date,
                                    data.certificate_number || 'CERT-' + Math.floor(100000 + Math.random() * 900000),
                                    type,
                                    data.download_url || ''
                                );
                                showPopup(data.message, true);
                                form.reset();
                                hideAllForms();

                                document.querySelectorAll('.signature-preview').forEach(el => {
                                    el.style.display = 'none';
                                });

                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            } else {
                                showPopup(data.message || 'Failed to generate certificate.', false);
                            }
                        })
                        .catch(err => {
                            showPopup(err.message, false);
                        });
                });
            }


            document.getElementById('bulkOfferUploadForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch('/accounts/certificate/offer/bulk-upload/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showPopup(`Successfully generated ${data.created.length} offer certificates.`, true);
                            this.reset();
                            hideAllForms();
                        } else {
                            showPopup(data.message || 'Bulk upload failed.', false);
                        }
                    })
                    .catch(() => showPopup('Something went wrong!', false));
            });

            document.getElementById('bulkCompletionUploadForm')?.addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch('/accounts/certificate/completion/bulk-upload/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            showPopup(`Successfully generated ${data.created.length} completion certificates.`, true);
                            this.reset();
                            hideAllForms();
                        } else {
                            showPopup(data.message || 'Bulk upload failed.', false);
                        }
                    })
                    .catch(() => showPopup('Something went wrong!', false));
            });

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            handleCertificateSubmit('createOfferForm', '/accounts/certificate/offer/create/', 'Offer Letter');
            handleCertificateSubmit('createCompletionForm', '/accounts/certificate/completion/create/', 'Completion Certificate');
            handleCertificateSubmit('addStudentForm', '/accounts/student/add/', 'Student');
        });
    </script>

    <!-- Success/Error Popup -->
    <div id="popupNotification" style="
    position: fixed;
    top: 20px;
    right: 20px;
    background-color: #4BB543;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 9999;
    display: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
"></div>

</body>

</html>